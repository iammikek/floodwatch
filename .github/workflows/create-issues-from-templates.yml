name: Create Issues from Templates

on:
  workflow_dispatch:
    inputs:
      template_pattern:
        description: 'Pattern to match template files (e.g., .github/ISSUE_TEMPLATE/*.md)'
        required: false
        default: '.github/ISSUE_TEMPLATE/*.md'
      dry_run:
        description: 'Dry run mode (will not create issues, only show what would be created)'
        required: false
        default: 'false'
        type: boolean

permissions:
  issues: write
  contents: read

jobs:
  create-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse and create issues
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e

          echo "ğŸ” Searching for issue templates matching pattern: ${{ inputs.template_pattern }}"

          # Count matching template files
          template_count=$(find . -path "./${{ inputs.template_pattern }}" -type f 2>/dev/null | wc -l)

          if [ "$template_count" -eq 0 ]; then
            echo "âŒ No template files found matching pattern: ${{ inputs.template_pattern }}"
            exit 0
          fi

          echo "ğŸ“‹ Found $template_count template file(s)"
          echo ""

          # Process each template file (using null-delimited input to handle spaces in filenames)
          while IFS= read -r -d '' template_file; do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“„ Processing: $template_file"

            # Try to extract title and labels from YAML front matter (between --- lines)
            fm_title=$(awk 'BEGIN{fm=0} /^---[[:space:]]*$/{if(fm==0){fm=1;next}else{fm=2}} (fm==1) && /^title:[[:space:]]*/{sub(/^title:[[:space:]]*/,""); print; exit}' "$template_file" || true)
            fm_labels=$(awk 'BEGIN{fm=0} /^---[[:space:]]*$/{if(fm==0){fm=1;next}else{fm=2}} (fm==1) && /^labels:[[:space:]]*/{sub(/^labels:[[:space:]]*/,""); print; exit}' "$template_file" || true)

            # Normalize front matter labels (remove spaces after commas)
            if [ -n "$fm_labels" ]; then
              fm_labels=$(echo "$fm_labels" | sed 's/^"//;s/"$//' | sed 's/, */,/g')
            fi

            # Extract title fallback (first heading after "# Issue:")
            title=${fm_title}
            if [ -z "$title" ]; then
              title=$(grep -m 1 "^# Issue:" "$template_file" | sed 's/^# Issue: //' || true)
            fi

            # If no "# Issue:" heading, try to get first heading
            if [ -z "$title" ]; then
              title=$(grep -m 1 "^# " "$template_file" | sed 's/^# //' || true)
            fi

            # Extract labels: prefer front matter, else parse "## Labels" section
            labels="${fm_labels}"
            if [ -z "$labels" ]; then
              labels=""
              in_labels_section=false
              while IFS= read -r line; do
                if [[ "$line" == "## Labels" ]]; then
                  in_labels_section=true
                  continue
                fi
                if [[ "$in_labels_section" == true ]]; then
                  if [[ "$line" =~ ^## ]]; then
                    break
                  fi
                  if [[ "$line" =~ ^-[[:space:]]*(.*) ]]; then
                    label="${BASH_REMATCH[1]}"
                    if [ -z "$labels" ]; then
                      labels="$label"
                    else
                      labels="$labels,$label"
                    fi
                  fi
                fi
              done < "$template_file"
            fi

            # Read the body, stripping YAML front matter if present
            body=$(awk 'BEGIN{fm=0} {if(NR==1 && $0 ~ /^---[[:space:]]*$/){fm=1; next} if(fm==1){if($0 ~ /^---[[:space:]]*$/){fm=0; next} else {next}} print}' "$template_file")

            if [ -z "$title" ]; then
              echo "âš ï¸  Warning: Could not extract title from $template_file, skipping..."
              continue
            fi

            echo "  Title: $title"
            echo "  Labels: ${labels:-none}"

            # Check if issue with exact same title already exists
            existing_issue=$(gh issue list --repo ${{ github.repository }} --search "is:issue \"$title\" in:title" --json number,title --jq ".[] | select(.title == \"$title\") | .number" 2>/dev/null | head -1 || true)

            if [ -n "$existing_issue" ]; then
              echo "  â„¹ï¸  Issue already exists: #$existing_issue"
              echo "  Skipping creation to avoid duplicates"
              continue
            fi

            # Filter labels to those that exist in the repo
            filtered_labels=""
            if [ -n "$labels" ]; then
              # Get existing label names
              existing_labels=$(gh label list --repo ${{ github.repository }} --json name --jq '.[].name' 2>/dev/null || true)
              IFS=',' read -r -a label_arr <<< "$labels"
              for lbl in "${label_arr[@]}"; do
                lbl_trimmed=$(echo "$lbl" | sed 's/^ *//;s/ *$//')
                if echo "$existing_labels" | grep -Fxq "$lbl_trimmed"; then
                  if [ -z "$filtered_labels" ]; then
                    filtered_labels="$lbl_trimmed"
                  else
                    filtered_labels="$filtered_labels,$lbl_trimmed"
                  fi
                else
                  echo "  âš ï¸  Skipping non-existent label: $lbl_trimmed"
                fi
              done
            fi

            if [ "${{ inputs.dry_run }}" == "true" ]; then
              echo "  ğŸƒ DRY RUN - Would create issue with:"
              echo "     Title: $title"
              echo "     Labels: ${filtered_labels:-none}"
              echo "     Body length: $(echo "$body" | wc -c) characters"
            else
              echo "  âœ… Creating issue..."

              # Create the issue
              if [ -n "$filtered_labels" ]; then
                issue_url=$(gh issue create \
                  --title "$title" \
                  --body "$body" \
                  --label "$filtered_labels" \
                  --repo ${{ github.repository }})
              else
                issue_url=$(gh issue create \
                  --title "$title" \
                  --body "$body" \
                  --repo ${{ github.repository }})
              fi

              echo "  âœ¨ Created issue: $issue_url"
            fi
            echo ""
          done < <(find . -path "./${{ inputs.template_pattern }}" -type f -print0 2>/dev/null)

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Done processing templates!"
