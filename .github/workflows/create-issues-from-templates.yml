name: Create Issues from Templates

on:
  workflow_dispatch:
    inputs:
      template_pattern:
        description: 'Pattern to match template files (e.g., docs/*-issue-*.md)'
        required: false
        default: 'docs/*-issue-*.md'
      dry_run:
        description: 'Dry run mode (will not create issues, only show what would be created)'
        required: false
        default: 'false'
        type: boolean

permissions:
  issues: write
  contents: read

jobs:
  create-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse and create issues
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e

          echo "ğŸ” Searching for issue templates matching pattern: ${{ inputs.template_pattern }}"

          # Count matching template files
          template_count=$(find . -path "./${{ inputs.template_pattern }}" -type f 2>/dev/null | wc -l)

          if [ "$template_count" -eq 0 ]; then
            echo "âŒ No template files found matching pattern: ${{ inputs.template_pattern }}"
            exit 0
          fi

          echo "ğŸ“‹ Found $template_count template file(s)"
          echo ""

          # Process each template file (using null-delimited input to handle spaces in filenames)
          while IFS= read -r -d '' template_file; do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“„ Processing: $template_file"

            # Extract title (first heading after "# Issue:")
            title=$(grep -m 1 "^# Issue:" "$template_file" | sed 's/^# Issue: //' || true)

            # If no "# Issue:" heading, try to get first heading
            if [ -z "$title" ]; then
              title=$(grep -m 1 "^# " "$template_file" | sed 's/^# //' || true)
            fi

            # Extract labels from the Labels section
            labels=""
            in_labels_section=false
            while IFS= read -r line; do
              if [[ "$line" == "## Labels" ]]; then
                in_labels_section=true
                continue
              fi
              if [[ "$in_labels_section" == true ]]; then
                if [[ "$line" =~ ^## ]]; then
                  break
                fi
                if [[ "$line" =~ ^-[[:space:]]*(.*) ]]; then
                  label="${BASH_REMATCH[1]}"
                  if [ -z "$labels" ]; then
                    labels="$label"
                  else
                    labels="$labels,$label"
                  fi
                fi
              fi
            done < "$template_file"

            # Read the entire file as the body
            body=$(cat "$template_file")

            if [ -z "$title" ]; then
              echo "âš ï¸  Warning: Could not extract title from $template_file, skipping..."
              continue
            fi

            echo "  Title: $title"
            echo "  Labels: ${labels:-none}"

            # Check if issue with exact same title already exists
            existing_issue=$(gh issue list --repo ${{ github.repository }} --search "is:issue \"$title\" in:title" --json number,title --jq ".[] | select(.title == \"$title\") | .number" 2>/dev/null | head -1 || true)

            if [ -n "$existing_issue" ]; then
              echo "  â„¹ï¸  Issue already exists: #$existing_issue"
              echo "  Skipping creation to avoid duplicates"
              continue
            fi

            if [ "${{ inputs.dry_run }}" == "true" ]; then
              echo "  ğŸƒ DRY RUN - Would create issue with:"
              echo "     Title: $title"
              echo "     Labels: ${labels:-none}"
              echo "     Body length: $(echo "$body" | wc -c) characters"
            else
              echo "  âœ… Creating issue..."

              # Create the issue
              if [ -n "$labels" ]; then
                issue_url=$(gh issue create \
                  --title "$title" \
                  --body "$body" \
                  --label "$labels" \
                  --repo ${{ github.repository }})
              else
                issue_url=$(gh issue create \
                  --title "$title" \
                  --body "$body" \
                  --repo ${{ github.repository }})
              fi

              echo "  âœ¨ Created issue: $issue_url"
            fi
            echo ""
          done < <(find . -path "./${{ inputs.template_pattern }}" -type f -print0 2>/dev/null)

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Done processing templates!"
