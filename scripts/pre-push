#!/bin/sh
set -e

# Always run from repo root
cd "$(git rev-parse --show-toplevel)"

# Determine branch and upstream
BRANCH="$(git rev-parse --abbrev-ref HEAD)"
UPSTREAM="origin/$BRANCH"

# Find changed PHP files between upstream and HEAD
if git rev-parse --verify "$UPSTREAM" >/dev/null 2>&1; then
    BASE="$(git merge-base HEAD "$UPSTREAM")"
    CHANGED_PHP="$(git diff --name-only --diff-filter=ACM "$BASE" HEAD | grep '\.php$' || true)"
else
    # New branch: approximate by looking at the last commit range
    CHANGED_PHP="$(git diff --name-only --diff-filter=ACM HEAD~ HEAD | grep '\.php$' || true)"
fi

if [ -n "$CHANGED_PHP" ]; then
    echo "PHP changes detected since upstream on branch $BRANCH:"
    echo "$CHANGED_PHP"
    echo "Running test suite (prefer Sail if available)..."
    if [ -x "./vendor/bin/sail" ]; then
        ./vendor/bin/sail test --compact
    else
        php artisan test --compact
    fi
else
    echo "No PHP changes detected since upstream on branch $BRANCH; skipping tests."
fi
